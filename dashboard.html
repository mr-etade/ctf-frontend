<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTF Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Highcharts CSS -->
    <link href="https://code.highcharts.com/css/highcharts.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
        }
        .ctf-header {
            background-color: #212529;
            color: #ffffff;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-bottom: 5px solid #0d6efd;
        }
        .dashboard-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 2rem;
        }
        .last-updated {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: right;
        }
        .footer {
            background-color: #212529;
            color: white;
            padding: 1rem 0;
            margin-top: 2rem;
        }
        .refresh-btn {
            background-color: #0d6efd;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .back-btn {
            margin: 1rem 0;
        }
        .back-to-home-btn {
            background-color: #0d6efd;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer; 
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="ctf-header text-center">
        <div class="container">
            <h1>Python Control Flow CTF</h1>
            <p class="lead">Live Dashboard</p>
            <div id="teamDisplay" class="mt-2" style="display: none;">
                <span class="badge bg-primary">Team: <span id="teamNameDisplay"></span></span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row mb-3">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>Competition Statistics</h2>
                    <div>
                        <span class="last-updated">Last updated: <span id="updateTime">Just now</span></span>
                        <button id="refreshBtn" class="refresh-btn ms-2">⟳ Refresh</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Chart -->
        <div class="dashboard-container">
            <h3>Leaderboard</h3>
            <div id="leaderboardChart" class="chart-container"></div>
        </div>

        <!-- Progress Stats -->
        <div class="row">
            <div class="col-md-6">
                <div class="dashboard-container">
                    <h3>Progress Stats</h3>
                    <div id="progressChart" class="chart-container"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-container">
                    <h3>Difficulty Breakdown</h3>
                    <div id="difficultyChart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this before the footer section -->
    <div class="container">
        <a href="index.html" class="back-to-home-btn">← Back to Home</a>
    </div>

    <!-- Footer -->
    <footer class="footer text-center">
        <div class="container">
            <p>CMN115/CBS105 Introduction to Programming 2025 | Prepared by Mr. Eremas Tade</p>
        </div>
    </footer>

    <!-- Bootstrap JS + Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Highcharts JS -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    
    <!-- Dashboard Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('ctfTeamName')) {
                alert('Please register your team first');
                window.location.href = 'register.html';
            } else {
                pollLeaderboard();
            }
        });

        // Store chart references globally
        window.leaderboardChart = null;
        window.progressChart = null;
        window.difficultyChart = null;

        // Polling function for live updates
        function pollLeaderboard() {
            fetch('https://ctf-backend-rose.vercel.app/api/teams')
                .then(response => response.json())
                .then(teams => {
                    updateDashboardData(teams);
                    setTimeout(pollLeaderboard, 5000); // Poll every 5 seconds
                })
                .catch(err => {
                    console.error('Polling error:', err);
                    setTimeout(pollLeaderboard, 10000); // Retry after 10 seconds on error
                });
        }

        // Update all charts with new data
        function updateDashboardData(teams) {
            const currentTeamName = localStorage.getItem('ctfTeamName');
            const currentTeam = teams.find(team => team.name === currentTeamName);
            
            // Update timestamp
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
            
            // If no current team found, don't update the charts
            if (!currentTeam) {
                console.error('Current team not found in leaderboard data');
                return;
            }
            
            // Calculate stats for current team only
            const teamFlags = currentTeam.flags || [];
            const progressData = {
                solved: teamFlags.length,
                unsolved: 30 - teamFlags.length // Assuming 30 total flags
            };
            
            // Calculate difficulty breakdown for current team
            const difficultyData = {
                easy: { solved: 0, total: 10 },
                medium: { solved: 0, total: 15 },
                hard: { solved: 0, total: 5 }
            };
            
            // Count flags by actual difficulty for current team
            teamFlags.forEach(flag => {
                switch(flag.difficulty) {
                    case 'easy':
                        difficultyData.easy.solved++;
                        break;
                    case 'medium':
                        difficultyData.medium.solved++;
                        break;
                    case 'hard':
                        difficultyData.hard.solved++;
                        break;
                }
            });

            // Update leaderboard chart with all teams
            if (window.leaderboardChart) {
                window.leaderboardChart.update({
                    series: [{
                        data: teams.map(team => team.score || 0)
                    }],
                    xAxis: {
                        categories: teams.map(team => team.name)
                    }
                });
            } else {
                initLeaderboardChart(teams);
            }

            // Update progress chart with current team data only
            if (window.progressChart) {
                window.progressChart.series[0].setData([
                    { name: 'Solved', y: progressData.solved, color: '#28a745' },
                    { name: 'Unsolved', y: progressData.unsolved, color: '#dc3545' }
                ]);
                window.progressChart.setTitle({ text: `Your Progress: ${currentTeamName}` });
            } else {
                initProgressChart(progressData, currentTeamName);
            }

            // Update difficulty chart with current team data only
            if (window.difficultyChart) {
                window.difficultyChart.series[0].setData([
                    difficultyData.easy.solved,
                    difficultyData.medium.solved,
                    difficultyData.hard.solved
                ]);
                window.difficultyChart.series[1].setData([
                    difficultyData.easy.total - difficultyData.easy.solved,
                    difficultyData.medium.total - difficultyData.medium.solved,
                    difficultyData.hard.total - difficultyData.hard.solved
                ]);
                window.difficultyChart.setTitle({ text: `Your Difficulty Breakdown: ${currentTeamName}` });
            } else {
                initDifficultyChart(difficultyData, currentTeamName);
            }
        }

        // Initialize leaderboard chart
        function initLeaderboardChart(teams) {
            window.leaderboardChart = Highcharts.chart('leaderboardChart', {
                chart: { 
                    type: 'bar',
                    height: 400 + (teams.length * 20) // Dynamic height based on number of teams
                },
                title: { text: 'Team Leaderboard' },
                xAxis: {
                    categories: teams.map(team => team.name),
                    title: { text: null }
                },
                yAxis: {
                    min: 0,
                    title: { text: 'Points' },
                    allowDecimals: false
                },
                legend: { enabled: false },
                tooltip: {
                    formatter: function() {
                        const team = teams.find(t => t.name === this.key);
                        return `<b>${this.key}</b><br/>Points: ${this.y}<br/>Flags: ${team.flags ? team.flags.length : 0}`;
                    }
                },
                plotOptions: {
                    bar: {
                        dataLabels: { 
                            enabled: true,
                            formatter: function() {
                                return `${this.key}: ${this.y} pts`;
                            }
                        },
                        colorByPoint: true,
                        colors: teams.map((team, i) => {
                            const currentTeam = localStorage.getItem('ctfTeamName');
                            return team.name === currentTeam ? '#FFD700' : // Gold for current team
                                Highcharts.getOptions().colors[i % Highcharts.getOptions().colors.length];
                        })
                    }
                },
                series: [{
                    name: 'Points',
                    data: teams.map(team => ({
                        name: team.name,
                        y: team.score || 0
                    }))
                }]
            });
        }

        // Initialize progress chart
        function initProgressChart(data, teamName) {
            window.progressChart = Highcharts.chart('progressChart', {
                chart: { type: 'pie' },
                title: { text: `Your Progress: ${teamName}` },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.y}'
                        }
                    }
                },
                series: [{
                    name: 'Flags',
                    colorByPoint: true,
                    data: [{
                        name: 'Solved',
                        y: data.solved,
                        color: '#28a745'
                    }, {
                        name: 'Unsolved',
                        y: data.unsolved,
                        color: '#dc3545'
                    }]
                }]
            });
        }

        // Initialize difficulty chart
        function initDifficultyChart(data, teamName) {
            window.difficultyChart = Highcharts.chart('difficultyChart', {
                chart: { type: 'column' },
                title: { text: `Your Difficulty Breakdown: ${teamName}` },
                xAxis: {
                    categories: ['Easy', 'Medium', 'Hard']
                },
                yAxis: {
                    min: 0,
                    title: { text: 'Flags Captured' },
                    allowDecimals: false,
                    stackLabels: {
                        enabled: true,
                        style: {
                            fontWeight: 'bold',
                            color: 'gray'
                        }
                    }
                },
                legend: {
                    align: 'right',
                    verticalAlign: 'top',
                    layout: 'vertical'
                },
                tooltip: {
                    headerFormat: '<b>{point.x}</b><br/>',
                    pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
                },
                plotOptions: {
                    column: {
                        stacking: 'normal',
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                series: [{
                    name: 'Solved',
                    data: [
                        data.easy.solved,
                        data.medium.solved,
                        data.hard.solved
                    ],
                    color: '#28a745'
                }, {
                    name: 'Remaining',
                    data: [
                        data.easy.total - data.easy.solved,
                        data.medium.total - data.medium.solved,
                        data.hard.total - data.hard.solved
                    ],
                    color: '#dc3545'
                }]
            });
        }

        // Manual refresh button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            fetch('https://ctf-backend-rose.vercel.app/api/teams')
                .then(response => response.json())
                .then(teams => {
                    updateDashboardData(teams);
                });
        });

        // Check if team is registered
        document.addEventListener('DOMContentLoaded', function() {
            const teamName = localStorage.getItem('ctfTeamName');
            if (teamName) {
                document.getElementById('teamDisplay').style.display = 'block';
                document.getElementById('teamNameDisplay').textContent = teamName;
            }
        });
    </script>
    <script>
    // Check if team is registered
    document.addEventListener('DOMContentLoaded', function() {
        const teamName = localStorage.getItem('ctfTeamName');
        if (teamName) {
            document.getElementById('teamDisplay').style.display = 'block';
            document.getElementById('teamNameDisplay').textContent = teamName;
            
            // Hide register link if on index.html
            if (window.location.pathname.includes('index.html')) {
                const registerLink = document.querySelector('a[href="register.html"]');
                if (registerLink) {
                    registerLink.style.display = 'none';
                }
            }
        }
    });
    </script>
</body>
</html>
